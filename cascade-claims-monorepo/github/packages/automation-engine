import { chromium, Browser, Page } from 'playwright';

/**
 * STATE FARM BYPASS ENGINE
 * Difficulty: High (Uses LYNX Services redirection)
 */
export class StateFarmBypass {
  async execute(claim: any) {
    const browser = await chromium.launch({ headless: true });
    const page = await browser.newPage();

    try {
      console.log(`[SF-BOT] Initiating claim for ${claim.lastName}`);
      
      // 1. State Farm Landing
      await page.goto('https://www.statefarm.com/claims/file-a-claim');
      await page.click('text="Glass only"');

      // 2. The "Handshake" (They pass you to LYNX/Safelite Solutions)
      // We must wait for the URL to change domains
      await page.waitForURL(/.*lynxservices.*/, { timeout: 15000 });
      console.log('[SF-BOT] Intercepted LYNX Portal Redirection');

      // 3. Data Entry
      await page.fill('#policyNumber', claim.policyNumber);
      await page.fill('#dateOfLoss', claim.dateOfLoss);

      // 4. The Steering Trap
      // State Farm often hides the "Select Shop" button under a "Program Shop" accordion.
      // We force-expand it.
      const nonProgramLink = page.locator('#select-non-program-shop');
      if (await nonProgramLink.isVisible()) {
         await nonProgramLink.click();
      } else {
         // Fallback: If link is hidden, inject Javascript to reveal it
         await page.evaluate(() => {
            document.querySelector('#hidden-choice-layer').style.display = 'block';
         });
         await page.click('#hidden-choice-layer a');
      }

      // 5. Hard-Code Cascade Auto Glass
      await page.fill('input[aria-label="Shop Name"]', 'Cascade Auto Glass');
      await page.fill('input[aria-label="Zip Code"]', '83704');
      await page.keyboard.press('Enter');

      // 6. Confirm "Out of Network" Warning (The scary popup)
      // We programmatically click "I Understand" to dismiss the fear tactic
      await page.click('button:has-text("I accept the terms")');

      const claimId = await page.innerText('.claim-confirmation-header');
      return { success: true, claimId };

    } catch (err) {
      // Take a "Crime Scene Photo" (Screenshot) so you can see why it failed
      await page.screenshot({ path: `logs/errors/${claim.lastName}-error.png` });
      return { success: false, error: err.message };
    } finally {
      await browser.close();
    }
  }
}
